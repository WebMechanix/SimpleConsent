/**!
 * SimpleConsent.js
 * 
 * Author: Derek Cavaliero (@derekcavaliero)
 * Repository: https://github.com/derekcavaliero/SimpleConsent
 * Version: 1.0.alpha
 * License: MIT
 */
class SimpleConsent{static#t=null;#e=null;#n=null;#i="simple-consent";#s=1;#o=["acceptAll","acceptSelected","close","denyAll","saveSettings","showSettings","toggleServices"];#a={};#c={actions:{banner:{_order:["showSettings","denyAll","acceptAll"],showSettings:!0,denyAll:!0,acceptAll:!0},modal:{_order:["denyAll","saveSettings","acceptSelected","acceptAll"],acceptAll:!0,acceptSelected:!0,saveSettings:!0,denyAll:!0}},consentModel:"opt-in",consentOn:!1,consentRequired:!1,content:{banner:{heading:"Privacy Notice",description:"This website uses cookies (or other browser storage) to deliver our services and/or analyze our website usage. This information is also shared with advertising partners through the use of tracking scripts/pixels.",actions:{acceptAll:"Accept All",denyAll:"Deny All",showSettings:"Edit Preferences"}},links:{privacyPolicy:{text:"Privacy Policy",url:"#"},termsOfService:null,cookiePolicy:{text:"Cookie Policy",url:"#"}},modal:{heading:"Your Privacy Choices",description:"This website uses services that utilize storage features in your browser (via cookies or other browser storage functionality) to collect information. You can choose to grant or deny certain types of data collection using the controls below.",toggleAll:"Enable/Disable All",actions:{acceptAll:"Accept All",acceptSelected:"Accept Selected",denyAll:"Deny All",saveSettings:"Save Preferences"}},notices:{required:{badge:"Always Enabled"},gpc:{badge:"Disabled by GPC",description:"Some services have been automatically disabled to respect your Global Privacy Control opt-out signal."}}},cookieDomain:null,cookieExpiryDays:365,geoLocate:null,gtm:{containerId:null,loadContainer:!1},l10n:{},locale:null,onInit:function(t){},onUpdateAfter:function(t){},onUpdateBefore:function(t){},services:{},storageMethod:"hybrid",storageName:"simple_consent",templates:{banner:'<div class="consent-banner"><div class="consent-ui__content" role="alert" aria-labelledby="consentBannerHeading" aria-describedby="consentBannerDescription"><div class="consent-ui__header"><h2 class="consent-banner__heading" id="consentBannerHeading">{{ heading }}</h2><button aria-label="Close" data-consent-close></button></div><div class="consent-banner__description" id="consentBannerDescription">{{ description }}</div><div data-consent-notices></div><div data-consent-actions></div><div data-consent-links class="consent-ui__footer"></div></div></div>',modal:'<div class="consent-modal" aria-labelledby="consentModalHeading" aria-describedby="consentModalDescription"><div class="consent-ui__content"><div class="consent-ui__header"><h2 class="consent-modal__heading" id="consentModalHeading">{{ heading }}</h2><button aria-label="Close" data-consent-close></button></div><div class="consent-modal__description" id="consentModalDescription">{{ description }}</div><div data-consent-notices></div><form data-consent-settings><div data-consent-types class="consent-modal__body"></div><div data-consent-actions></div></form><div data-consent-links class="consent-ui__footer"></div></div></div>',notice:"<div>{{ description }}</div>",service:"<div> <dt>{{ name }}</dt><dd>{{ description }}</dd></div>",settingsButton:'<button><svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960" fill="currentColor" style="pointer-events: none"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-75 29-147t81-128.5q52-56.5 125-91T475-881q21 0 43 2t45 7q-9 45 6 85t45 66.5q30 26.5 71.5 36.5t85.5-5q-26 59 7.5 113t99.5 56q1 11 1.5 20.5t.5 20.5q0 82-31.5 154.5t-85.5 127q-54 54.5-127 86T480-80Zm-60-480q25 0 42.5-17.5T480-620q0-25-17.5-42.5T420-680q-25 0-42.5 17.5T360-620q0 25 17.5 42.5T420-560Zm-80 200q25 0 42.5-17.5T400-420q0-25-17.5-42.5T340-480q-25 0-42.5 17.5T280-420q0 25 17.5 42.5T340-360Zm260 40q17 0 28.5-11.5T640-360q0-17-11.5-28.5T600-400q-17 0-28.5 11.5T560-360q0 17 11.5 28.5T600-320ZM480-160q122 0 216.5-84T800-458q-50-22-78.5-60T683-603q-77-11-132-66t-68-132q-80-2-140.5 29t-101 79.5Q201-644 180.5-587T160-480q0 133 93.5 226.5T480-160Zm0-324Z"/></svg></button>',type:'<div class="consent-type"><input type="checkbox" role="switch" id="type-{{ key }}" name="{{ key }}"><div class="consent-type__text"><div class="consent-type__header"><label for="type-{{ key }}">{{ name }}</label></div><div class="consent-type__desc">{{ description }}</div><dl data-consent-type-services></dl></div></div>'},types:{},ui:{actionClasses:{_all:null,acceptAll:null,acceptSelected:null,denyAll:null,showSettings:null,saveSettings:null},placement:{banner:["bottom","left"],settingsButton:["bottom","left"]},rootClass:"simple-consent",rootId:"simple-consent",showBranding:!0}};#l=null;#r={gpc:navigator.globalPrivacyControl||!1,dnt:navigator.doNotTrack||!1};#d={necessary:{key:"necessary",name:"Strictly Necessary",description:"These cookies/services are required for our website(s) to function properly and cannot be disabled.",required:!0}};#h={banner:null,modal:null,root:null,settings:null,settingsButton:null};constructor(t){if(SimpleConsent.#t)return SimpleConsent.#t;SimpleConsent.#t=this;try{this.#g(t)}catch(t){}}get#u(){return this.constructor.name}get#p(){const t={};for(let[e,n]of Object.entries(this.#a.services))for(let e of n.types)t[e]||(t[e]=[]),t[e].push(n);return t}get config(){return this.#a}get signals(){return this.#r}get storage(){if(this.#l)return this.#l;if(["localstorage","hybrid"].includes(this.#a.storageMethod)){let t=localStorage.getItem(this.#a.storageName);if(t)return this.#l=JSON.parse(t),this.#l}if(["cookie","hybrid"].includes(this.#a.storageMethod)){let t=`${this.#a.storageName}=`,e=decodeURIComponent(document.cookie).split(";");for(let n=0;n<e.length;n++){let i=e[n];for(;" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return JSON.parse(i.substring(t.length,i.length))}}return null}async#g(t){if(t._default){this.#n=t,t=t._default,this.#a=this.#m(this.#c,t);let e=this.#n._router;this.#a.geoLocate&&"function"==typeof this.#a.geoLocate&&this.#a.geoLocate().then((t=>{this.#e=t,e?(e.forEach((e=>{e.geoMatch&&t.match(e.geoMatch)&&this.#n.hasOwnProperty(e.config)&&(this.#a=this.#m(this.#a,this.#n[e.config]))})),this.#f()):this.#f()}))}else this.#a=this.#m(this.#c,t),this.#f()}#f(){this.#a.cookieDomain=this.#y(),this.#d=this.#m(this.#d,this.#a.types),this.#v(),this.#b(),this.#w(),this.#S(),this.#A(),this.#C(),this.#_(),this.#T(),"function"==typeof this.#a.onInit&&(this.#a.onInit(this.#l),this.#k("init",this.#l))}#b(){document.addEventListener(`${this.#i}:modal.show.before`,(t=>{const e=t.detail.querySelectorAll("[data-consent-action]");if(!this.#l._datetime)return e.forEach((t=>{t.style.display="saveSettings"!==t.getAttribute("data-consent-action")?"block":"none"})),void this.hide("banner");e.forEach((t=>{t.style.display="saveSettings"!==t.getAttribute("data-consent-action")?"none":"block"}))})),document.addEventListener(`${this.#i}:modal.close.before`,(t=>{this.#l._datetime||this.show("banner")})),document.addEventListener(`${this.#i}:settings.update`,(t=>{this.#q("update"),this.show("settingsButton")})),document.addEventListener(`${this.#i}:settings.load`,(t=>{this.#q("default")}))}#A(){document.addEventListener("keyup",(t=>{"Escape"===t.key&&this.#h.modal&&this.#h.modal.hasAttribute("aria-expanded")&&this.#h.modal.querySelector("[data-consent-close]").click()})),document.addEventListener("click",(t=>{let e=t.target.closest("[data-consent-action]");if(e)return t.preventDefault(),void this[{showSettings:"show",acceptAll:"accept",acceptSelected:"save",denyAll:"deny",saveSettings:"save"}[e.dataset.consentAction]]();t.target.hasAttribute("data-consent-close")&&(t.preventDefault(),this.#E(t.target)),t.target.hasAttribute("data-consent-toggle-services")&&(t.preventDefault(),this.#M(t.target))}))}#C(){if(!this.#a.consentOn||this.#l._datetime)return;const t=()=>{this.changeAll(),this.save(!0),o()},e=e=>{window.scrollY<.05*window.innerHeight||t()},n=((t,e)=>{let n;return function(...i){clearTimeout(n),n=setTimeout((()=>t.apply(this,i)),e)}})(e,100);this.#a.consentOn.includes("scroll")&&document.addEventListener("scroll",n);const i=e=>{e.target.closest("[data-consent-tpl]")||t()};this.#a.consentOn.includes("click")&&document.addEventListener("mousedown",i);const s=e=>{t()};this.#a.consentOn.includes("banner.close")&&document.addEventListener(`${this.#i}:banner.close.after`,s);const o=()=>{document.removeEventListener("mousedown",i),document.removeEventListener(`${this.#i}:banner.close.after'`,s),document.removeEventListener("scroll",e)}}#L(t){return t?"granted":"denied"}#x(t,e){for(const n in e)e.hasOwnProperty(n)&&t.setAttribute(n,e[n])}#$(){let t={};if(this.#l)for(let e in this.#l)this.#l.hasOwnProperty(e)&&!e.startsWith("_")&&(t[e]=this.#L(this.#l[e]),this.#d[e]&&this.#d[e].mapTo&&this.#d[e].mapTo.forEach((n=>{t[n]=this.#L(this.#l[e])})));return t}#E(t){if(this.#a.consentRequired&&!this.#l)return;const e=t.closest("[data-consent-tpl]");e&&(this.#k(`${e.dataset.consentTpl}.close.before`,e),e.removeAttribute("aria-expanded"),this.#k(`${e.dataset.consentTpl}.close.after`,e))}#m(t,e){for(const n in e)e.hasOwnProperty(n)&&(Array.isArray(e[n])?t[n]=e[n].slice():"object"==typeof e[n]&&null!==e[n]?(t[n]||(t[n]={}),this.#m(t[n],e[n])):t[n]=e[n]);return t}#O(){document.cookie.split(";").forEach((t=>{const e=t.split("=")[0].trim();patterns.some((t=>new RegExp(t).test(e)))&&(document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`)}))}#D(){return Object.values(this.#a.services).reduce(((t,e)=>t.concat(e.cookies.map((t=>t.name)))),[])}#P(t){return this.#d[t]||!1}#v(){window.dataLayer=window.dataLayer||[],window.gtag||(window.gtag=function(){window.dataLayer.push(arguments)})}#S(){this.#a.gtm.loadContainer&&this.#a.gtm.containerId&&function(t,e,n,i,s){t[i]=t[i]||[],t[i].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var o=e.getElementsByTagName(n)[0],a=e.createElement(n);a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+s,o.parentNode.insertBefore(a,o)}(window,document,"script","dataLayer",this.#a.gtm.containerId)}#q(t){let e=this.#$(),n={default:"load"}[t]||t;window.gtag("consent",t,e);let i={event:`${this.#i}:${n}`,consent:e,consentMeta:{model:this.#a.consentModel,geo:this.#e,gpc:this.#r.gpc}};window.dataLayer.push(i),this.#k("datalayer.push",i)}#k(t,e){const n=new CustomEvent(`${this.#i}:${t}`,{detail:e});document.dispatchEvent(n)}#B(){this.hide("modal"),this.hide("banner")}#w(){if(this.#l=this.storage,this.#l)return void this.#k("settings.load",this.#l);this.#l={},this.#a.consentModel=this.#a.consentModel.toLowerCase().trim(),["opt-in","opt-out"].includes(this.#a.consentModel)||(this.#a.consentModel="opt-in");let t={"opt-in":!1,"opt-out":!0}[this.#a.consentModel];this.#r.gpc&&(t=!this.#r.gpc&&t);for(let[e,n]of Object.entries(this.#d))this.#l[e]=!!n.required||t;this.#k("settings.load",this.#l)}#_(){if(!this.#a.l10n)return;if(!this.#a.locale){const t=document.documentElement.lang;this.#a.locale=t||null}if(!this.#a.locale)return;this.#a.locale=this.#a.locale.toLowerCase();const t=this.#a.l10n[this.#a.locale];t&&(t.content&&(this.#a.content=this.#m(this.#a.content,t.content)),t.services&&(this.#a.services=t.services),t.types&&(this.#d=t.types))}#T(){this.#I();const t=document.createElement("div");if(t.id=this.#a.ui.rootId,t.className=this.#a.ui.rootClass,this.#h.modal=this.#N("modal",this.#a.content.modal),this.#x(this.#h.modal,{role:"dialog"}),this.#j(this.#h.modal),this.#U(this.#l,this.#h),t.appendChild(this.#h.modal),this.#h.banner=this.#N("banner",this.#a.content.banner),this.#j(this.#h.banner),this.#x(this.#h.banner,{role:"alert","data-consent-placement":this.#a.ui.placement.banner.join(",")}),t.appendChild(this.#h.banner),this.#r.gpc){let e=t.querySelectorAll("[data-consent-notices]");for(let t of e){let e=this.#N("notice",this.#a.content.notices.gpc);this.#x(e,{"data-consent-tpl":"notice","data-consent-notice":"info"}),t.appendChild(e)}}this.#H(t),this.#h.settingsButton=this.#N("settingsButton",{}),this.#x(this.#h.settingsButton,{role:"dialog","data-consent-tpl":"settingsButton","data-consent-action":"showSettings","data-consent-placement":this.#a.ui.placement.settingsButton.join(","),title:"Edit Preferences"}),t.appendChild(this.#h.settingsButton),document.body.appendChild(t),this.#h.root=t,this.#R()}#j(t){const e=t.dataset.consentTpl,n=this.#a.actions[e],i=t.querySelector("[data-consent-actions]");if(i)for(let t of this.#a.actions[e]._order){if(!n.hasOwnProperty(t)||!n[t]||!this.#o.includes(t))continue;let s=document.createElement("button");this.#a.ui.actionClasses._all&&s.classList.add(...this.#a.ui.actionClasses._all.split(" ")),this.#a.ui.actionClasses[t]&&s.classList.add(...this.#a.ui.actionClasses[t].split(" ")),s.setAttribute("data-consent-action",t),s.textContent=this.#a.content[e].actions[t],i.append(s)}}#U(){const t=this.#p;for(let[e,n]of Object.entries(this.#d)){this.#d[e].key=e;const i=this.#N("type",n);this.#x(i,{"data-consent-type":e});const s=i.querySelector("input");if(s.checked=!!this.#l[e],n.required&&(s.disabled=!0,s.checked=!0),this.#r.gpc&&n.gpc&&(s.disabled=!0,s.checked=!1,s.title=this.#a.content.notices.gpc.description),t[e]){const n=document.createElement("button");n.textContent=`${t[e].length} Service${t[e].length>1?"s":""}`,n.setAttribute("data-arrow","↓"),n.setAttribute("data-consent-toggle-services",e),i.querySelector(".consent-type__header").appendChild(n);const s=i.querySelector("[data-consent-type-services]");this.#x(s,{role:"list","data-consent-tpl":"services"});for(let n of t[e]){let t=this.#N("service",n);s.appendChild(t)}}this.#h.modal.querySelector("[data-consent-types]").appendChild(i)}this.#h.settings=this.#h.modal.querySelectorAll("[data-consent-settings] input")}#H(t){const e=this.#a.content.links,n=t.querySelectorAll("[data-consent-links]");if(n.length)for(let t of n){let n=0;for(let i in e){if(!e.hasOwnProperty(i)||!e[i])continue;if(n>0){let e=document.createElement("span");e.setAttribute("data-consent-link-delimiter",""),t.appendChild(e)}let s=document.createElement("a");s.href=e[i].url,s.textContent=e[i].text,t.appendChild(s),n++}if(t.closest('[data-consent-tpl="modal"]')&&this.#a.ui.showBranding){let e=document.createElement("a");e.setAttribute("data-consent-branding",""),e.href="https://github.com/WebMechanix/SimpleConsent/",e.target="_blank",e.textContent=`${this.#u}`,t.appendChild(e)}}}#I(){const t=`${this.#i}-styles`;let e=document.getElementById(t);e||(e=document.createElement("style"),e.id=t,e.textContent="[data-consent-tpl][role] { display: none; }[data-consent-tpl][role][aria-expanded] { display: flex !important; }[data-consent-tpl][role][aria-expanded] ~ [aria-expanded] { display: none !important; }",document.head.appendChild(e))}#N(t,e={}){const n=document.createElement("template");n.innerHTML=this.#a.templates[t].trim();for(let t in e)e.hasOwnProperty(t)&&!["actions","required"].includes(t)&&"string"==typeof e[t]&&(n.innerHTML=this.#z(n.innerHTML,t,e[t]));return this.#x(n.content.firstChild,{"data-consent-tpl":t}),n.content.firstChild}#y(){if(this.#a.cookieDomain)return this.#a.cookieDomain;const t=window.location.hostname;if("localhost"===t)return"";const e=t.split(".").reverse();let n=e[1]+"."+e[0];return e.length>2&&e[1].length<=3&&(n=e[2]+"."+n),n}#z(t,e,n){let i=new RegExp(`{{ ${e} }}`,"g"),s=n.replace(/<[^>]*>?/gm,"");return s=this.#J(s),t.replace(i,s)}#J(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}#R(){const t=this.#a.consentRequired;this.#l._datetime?this.show("settingsButton"):t?this.show("modal"):this.show("banner")}#Z(t){["cookie","hybrid"].includes(this.#a.storageMethod)&&(document.cookie=`${this.#a.storageName}=${JSON.stringify(t)}; expires=${new Date(Date.now()+24*this.#a.cookieExpiryDays*60*60*1e3).toUTCString()}; path=/; domain=${this.#a.cookieDomain}`),["cookie","hybrid"].includes(this.#a.storageMethod)&&localStorage.setItem(this.#a.storageName,JSON.stringify(t))}#Y(){localStorage.removeItem(this.#a.storageName),document.cookie=`${this.#a.storageName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${this.#a.cookieDomain}`}#M(t){const e=t.getAttribute("data-arrow");t.setAttribute("data-arrow","↓"===e?"↑":"↓");t.closest('[data-consent-tpl="type"]').querySelector("[data-consent-type-services]").toggleAttribute("aria-expanded")}accept(){this.changeAll(),this.save()}changeAll(t=!0){this.#h.settings.forEach((e=>{e.disabled||(e.checked=t)}))}deny(){this.changeAll(!1),this.save()}destroy(){this.#k("destroy"),this.#h.root.remove(),this.#Y(),SimpleConsent.#t&&(SimpleConsent.#t=null)}hide(t="modal"){this.#a.consentRequired&&!this.#l||this.#h[t].removeAttribute("aria-expanded")}reset(){this.#k("reset"),this.#Y(),this.#l=null,this.#w(),this.#C(),this.changeAll("opt-in"!==this.#a.consentModel),this.#R()}save(t=!1){"function"==typeof this.#a.onUpdateBefore&&this.#a.onUpdateBefore(this.#l),this.#l||(this.#l={});for(let t of this.#h.settings){if("necessary"==t.name)continue;const e=this.#P(t.name);this.#l[t.name]=t.checked,e.mapTo&&Array.isArray(e.mapTo)&&e.mapTo.forEach((e=>{this.#l[e]=t.checked,this.#k(`${e}.${this.#L(t.checked)}`)}));t.checked;this.#k(`${t.name}.${this.#L(t.checked)}`)}Object.entries({_datetime:(new Date).toISOString(),_id:crypto.randomUUID(),_geo:this.#e,_gpc:this.#r.gpc,_model:`${this.#a.consentModel}/`+(t?"implicit":"explicit"),_version:this.#s}).forEach((([t,e])=>{this.#l[t]=e})),this.#Z(this.#l),this.#k("settings.update",this.#l),"function"==typeof this.#a.onUpdateAfter&&this.#a.onUpdateAfter(this.#l),setTimeout((()=>this.#B()),150)}show(t="modal"){this.#k(`${t}.show.before`,this.#h[t]),this.#h[t].setAttribute("aria-expanded","true"),this.#k(`${t}.show.after`,this.#h[t])}static manager(t){return SimpleConsent.#t||(SimpleConsent.#t=new SimpleConsent(t)),SimpleConsent.#t}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector("script[data-config]");if(!t)return;let e=window[t.dataset.config]||{};new SimpleConsent(e),delete window[t.dataset.config]}));
