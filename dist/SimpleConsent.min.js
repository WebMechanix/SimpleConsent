/**!
 * SimpleConsent.js
 * 
 * Most consent/cookie banners are too bloated and try to be "everything to everyone" - SimpleConsent is hyperfocused on ease of use, 
 * particularly with Google Tag Manager's "Consent" APIs.
 * 
 * Author: Derek Cavaliero (@derekcavaliero)
 * Repository: https://github.com/derekcavaliero/SimpleConsent
 * Version: 1.0.beta
 * License: MIT
 */
class SimpleConsent{static#e=null;#t=["acceptAll","acceptSelected","close","denyAll","saveSettings","showSettings"];#n={actions:{banner:{showSettings:!0,denyAll:!0,acceptAll:!0},modal:{denyAll:!0,saveSettings:!0,acceptSelected:!0,acceptAll:!0}},consentModel:"opt-in",cookieDomain:null,cookieExpiryDays:365,cookieName:"simple_consent",dataLayer:window.dataLayer||[],forceConsent:!1,impliedConsentOn:!1,l10n:{},locale:null,location:null,locationLookup:function(){},onInit:function(e){},onUpdateAfter:function(e){},onUpdateBefore:function(e){},services:[],showEmptyTypes:!1,templates:{banner:'\n              <div class="consent-banner">\n                <div class="consent-ui__content" role="alert" aria-labelledby="consentBannerHeading" aria-describedby="consentBannerDescription">\n                  <div class="consent-ui__header">\n                    <h2 class="consent-banner__heading" id="consentBannerHeading">\n                      {{ heading }}\n                    </h2>\n                    <button aria-label="Close" data-consent-close></button>\n                  </div>\n                  <div class="consent-banner__description" id="consentBannerDescription">{{ description }}</div>\n                  <div data-consent-actions></div>\n                </div>\n              </div>\n              ',modal:'\n              <div class="consent-modal" role="dialog" aria-labelledby=consentModalHeading" aria-describedby="consentModalDescription">\n                <div class="consent-ui__content">\n                  <div class="consent-ui__header">\n                    <h2 class="consent-modal__heading" id="consentModalHeading">{{ heading }}</h2>\n                    <button aria-label="Close" data-consent-close></button>\n                  </div>\n                  <div class="consent-modal__description" id="consentModalDescription">{{ description }}</div>\n                  <form data-consent-settings>\n                    <div data-consent-types class="consent-modal__body">\n                    </div>\n                    <div data-consent-actions></div>\n                  </form>\n                </div>\n              </div>\n              ',type:'\n              <div class="consent-type">\n                <div class="consent-switch">\n                  <input type="checkbox" role="switch" id="type-{{ key }}" name="{{ key }}">\n                  <div class="consent-switch__text">\n                    <label for="type-{{ key }}">{{ label }}</label>\n                    <div>{{ description }}</div>\n                    <div data-consent-type-services></div>\n                  </div>\n                </div>\n              </div>\n              '},text:{banner:{heading:"Privacy Notice",description:"This website uses cookies to deliver our services and to analyze traffic. We also share information about your use of our site with advertising and other partners.",actions:{acceptAll:"Accept All",denyAll:"Decline All",showSettings:"Edit Settings"}},modal:{heading:"Consent & Privacy Settings",description:"This website uses services that store cookies on your browser to collect information. The information collected might relate to you, your preferences or your device, and is mostly used to make the site work as you expect it to and to provide a more personalized web experience. However, you can choose not to allow certain types of cookies & services (listed below).",toggleAll:"Enable/Disable All",actions:{acceptAll:"Accept All",acceptSelected:"Accept Selected",denyAll:"Decline All",saveSettings:"Save Preferences"}},urls:{privacyPolicy:"#/privacy-policy",termsOfService:"#/terms-of-service",cookiePolicy:"#/cookie-policy"}},theme:{actionClasses:{_all:null,acceptAll:null,acceptSelected:null,denyAll:null,showSettings:null,saveSettings:null},placement:{banner:["bottom","left"]},rootClass:"simple-consent",rootId:"simple-consent",scheme:"light"}};#i=null;#s=[{key:"necessary",label:"Strictly Necessary",description:"These cookies/services are required for our website(s) to function and cannot be disabled.",required:!0},{key:"analytics_storage",label:"Analytics Storage",description:"Enables storage, such as cookies and/or local/session storage related to analytics, for example, visit duration, and pages viewed."},{key:"ad_storage",label:"Advertising Storage",description:"Enables storage, such as cookies and/or local/session storage related to advertising."},{key:"ad_personalization",label:"Advertising Personalization",description:"Set consent for personalized advertising through the use of 3rd party cookies set by our partners."},{key:"ad_user_data",label:"Ad User Data",description:"Sets consent for sending user data to our advertising partners for online advertising purposes."},{key:"functionality_storage",label:"Functionality Storage",description:"Enables storage that supports the functionality of the website or app e.g. language settings."},{key:"personalization_storage",label:"Personalization Storage",description:"Enables storage related to personalization e.g. video recommendations, and account preferences."},{key:"security_storage",label:"Security Storage",description:"Enables services/storage related to security such as authentication functionality, fraud prevention, and other user protection."}];#o={banner:null,modal:null,root:null,settings:null};constructor(e){if(console.time("SimpleConsent"),SimpleConsent.#e)return SimpleConsent.#e;this.#n=this.#a(this.#n,e),this.#n.cookieDomain=this.#c(),this.#i=this.getStoredSettings(),SimpleConsent.#e=this,this.#l(),this.#r(),this.#d(),this.#h(),"function"==typeof this.#n.onInit&&this.#n.onInit(this.#i),console.timeEnd("SimpleConsent")}static manager(e){return SimpleConsent.#e||(SimpleConsent.#e=new SimpleConsent(e)),SimpleConsent.#e}#p(e,t){for(const n in t)t.hasOwnProperty(n)&&e.setAttribute(n,t[n])}#d(){document.addEventListener("click",(e=>{e.target.matches("[data-consent-action]")&&(e.preventDefault(),this[{showSettings:"show",acceptAll:"accept",acceptSelected:"save",denyAll:"deny",saveSettings:"save"}[e.target.dataset.consentAction]]()),e.target.matches("[data-consent-close]")&&this.#u(e.target)})),this.#g()}#h(){document.addEventListener("consent:modal.show.before",(e=>{const t=e.detail.querySelectorAll("[data-consent-action]");if(!this.#i)return t.forEach((e=>{e.style.display="saveSettings"!==e.getAttribute("data-consent-action")?"block":"none"})),void this.hide("banner");t.forEach((e=>{e.style.display="saveSettings"!==e.getAttribute("data-consent-action")?"none":"block"}))})),document.addEventListener("consent:modal.close.before",(e=>{this.#i||this.show("banner")}))}#g(){if(!this.#n.impliedConsentOn||this.#i)return;const e=()=>{this.changeAll(),this.save(!0),console.log("Implied consentToAll()"),o()},t=t=>{window.scrollY<.05*window.innerHeight||e()},n=((e,t)=>{let n;return function(...i){clearTimeout(n),n=setTimeout((()=>e.apply(this,i)),t)}})(t,100);this.#n.impliedConsentOn.includes("scroll")&&document.addEventListener("scroll",n);const i=t=>{t.target.closest("[data-consent-tpl]")||e()};this.#n.impliedConsentOn.includes("click")&&document.addEventListener("mousedown",i);const s=t=>{t.target.hasAttribute("data-consent-close")&&e()};this.#n.impliedConsentOn.includes("close")&&document.addEventListener("click",s);const o=()=>{document.removeEventListener("mousedown",i),document.removeEventListener("click",s),document.removeEventListener("scroll",t)}}#u(e){if(this.#n.forceConsent&&!this.#i)return;const t=e.closest("[data-consent-tpl]");t&&(this.#m(`consent:${t.dataset.consentTpl}.close.before`,t),t.classList.remove("is-open"),this.#m(`consent:${t.dataset.consentTpl}.close.after`,t))}#a(e,t){for(const n in t)t.hasOwnProperty(n)&&(Array.isArray(t[n])?e[n]=t[n].slice():"object"==typeof t[n]&&null!==t[n]?(e[n]||(e[n]={}),this.#a(e[n],t[n])):e[n]=t[n]);return e}#m(e,t){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}#f(e){this.#n.dataLayer.push({event:"consent.update",consent:{settings:this.#i}})}#y(){const e={};for(let t of this.#n.services)for(let n of t.types)e[n]||(e[n]=[]),e[n].push(t);return e}#v(){this.hide("modal"),this.hide("banner")}#l(){if(!this.#n.l10n)return;if(!this.#n.locale){const e=document.documentElement.lang;this.#n.locale=e?e.split("-")[0]:null}if(!this.#n.locale)return void console.warn("SimpleConsent: No locale set or detected. Using defaults.");this.#n.locale=this.#n.locale.toLowerCase();const e=this.#n.l10n[this.#n.locale];e?e.text&&(this.#n.text=this.#a(this.#n.text,e.text)):console.warn(`SimpleConsent: No localization found for "${this.#n.locale}". Using defaults.`)}#r(){const e=document.createElement("div");e.id=this.#n.theme.rootId,e.classList.add(...this.#n.theme.rootClass.split(" ")),this.#o.modal=this.#b("modal",this.#n.text.modal),this.#S(this.#o.modal),this.#C(),e.appendChild(this.#o.modal),this.#o.banner=this.#b("banner",this.#n.text.banner),this.#S(this.#o.banner),this.#i||this.#n.forceConsent||this.#o.banner.classList.add("is-open"),this.#p(this.#o.banner,{"data-placement":this.#n.theme.placement.banner.join(",")}),e.appendChild(this.#o.banner),document.body.appendChild(e),this.#o.root=e,!this.#i&&this.#n.forceConsent&&this.show()}#S(e){const t=e.dataset.consentTpl,n=this.#n.actions[t],i=e.querySelector("[data-consent-actions]");if(i)for(let e in n){if(!n.hasOwnProperty(e)||!n[e]||!this.#t.includes(e))continue;let s=document.createElement("button");this.#n.theme.actionClasses[e]&&(this.#n.theme.actionClasses._all&&s.classList.add(...this.#n.theme.actionClasses._all.split(" ")),s.classList.add(...this.#n.theme.actionClasses[e].split(" "))),s.setAttribute("data-consent-action",e),s.textContent=this.#n.text[t].actions[e],i.append(s)}else console.warn(`SimpleConsent Template Error: "${t}" does not contain a [data-consent-actions] target.`)}#C(){const e=this.#y();for(let t of this.#s){if(!e[t.key]&&!t.required)continue;const n=this.#b("type",t),i=n.querySelector("input");this.#p(n,{"data-consent-type":t.key}),this.#i&&this.#i[t.key]&&(i.checked=!0),t.required&&(i.disabled=!0,i.checked=!0),this.#o.modal.querySelector("[data-consent-types]").appendChild(n)}this.#o.settings=this.#o.modal.querySelectorAll("[data-consent-settings] input")}#b(e,t={}){const n=document.createElement("template");n.innerHTML=this.#n.templates[e].trim();for(let e in t){if(!t.hasOwnProperty(e)||["actions","required"].includes(e))continue;let i=new RegExp(`{{ ${e} }}`,"g"),s=t[e].replace(/<\/?[^>]+(>|$)/g,"");n.innerHTML=n.innerHTML.replace(i,s)}return this.#p(n.content.firstChild,{"data-consent-tpl":e}),n.content.firstChild}#c(){if(this.#n.cookieDomain)return this.#n.cookieDomain;const e=window.location.hostname.split(".").reverse();let t=e[1]+"."+e[0];return e.length>2&&e[1].length<=3&&(t=e[2]+"."+t),t}save(e=!1){"function"==typeof this.#n.onUpdateBefore&&this.#n.onUpdateBefore(this.#i);for(let e of this.#o.settings)this.#i||(this.#i={}),this.#i[e.name]=e.checked;this.#i._datetime=(new Date).toISOString(),this.#i._location=this.#n.location,this.#i._id=crypto.randomUUID(),this.#i._mode=e?"implicit":"explicit",document.cookie=`${this.#n.cookieName}=${JSON.stringify(this.#i)}; expires=${new Date(Date.now()+24*this.#n.cookieExpiryDays*60*60*1e3).toUTCString()}; path=/; domain=${this.#n.cookieDomain}`,"function"==typeof this.#n.onUpdateAfter&&this.#n.onUpdateAfter(this.#i),this.#v()}accept(){this.changeAll(),this.save()}changeAll(e=!0){this.#o.settings.forEach((t=>{t.disabled||(t.checked=e)}))}deny(){this.changeAll(!1),this.save()}forget(){document.cookie=`${this.#n.cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${this.#n.cookieDomain}`}getStoredSettings(){let e=`${this.#n.cookieName}=`,t=decodeURIComponent(document.cookie).split(";");for(let n=0;n<t.length;n++){let i=t[n];for(;" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(e))return JSON.parse(i.substring(e.length,i.length))}return null}hide(e="modal"){this.#n.forceConsent&&!this.#i||this.#o[e].classList.remove("is-open")}show(e="modal"){this.#m(`consent:${e}.show.before`,this.#o[e]),this.#o[e].classList.add("is-open"),this.#m(`consent:${e}.show.after`,this.#o[e])}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("script[data-consent-config]");if(!e)return;const t=window[e.dataset.consentConfig]||{};new SimpleConsent(t),delete window[e.dataset.consentConfig]}));
